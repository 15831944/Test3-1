//================== SysCAD - Copyright Kenwalt (Pty) Ltd ===================
// $Nokeywords: $
//===========================================================================
/* -3 */
/************************************ C3AM.C *******************************/
/**************** Arrays of three-dimensional homogeneous points ***********/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                     All rights reserved                  !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
#ifdef   SPLINE
#include <c3apriv.h>
#include <c3hdefs.h>
#include <c3tpriv.h>
#include <c3vdefs.h>
#include <c3vmcrs.h>

/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c3a_sub ( a, d, pt, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                   All rights reserved                    !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/

HPT3 *a, *b ;     /* Input and output array ; may coincide */
INT  d ;            /* Number of points */
PT3  pt ;           /* Point being subtracted */
{
    INT i ;

    for ( i=0 ; i<d ; i++ ) {
        b[i][0] = a[i][0] - pt[0] * a[i][3] ;
        b[i][1] = a[i][1] - pt[1] * a[i][3] ;
        b[i][2] = a[i][2] - pt[2] * a[i][3] ;
        b[i][3] = a[i][3] ;
    }
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c3a_pt_hpt ( a, d, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                   All rights reserved                    !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/

PT3 *a ;       /* a[d] */
INT d ;
HPT3 *b ;      /* b[d] */

{
    INT i ;

    for ( i=0 ; i<d ; i++ ) {
        C3V_COPY ( a[i], b[i] ) ;
        b[i][3] = 1.0 ;
    }
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE BOOLEAN c3a_hpt_pt ( b, d, a ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                   All rights reserved                    !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/

HPT3 *b ;      /* b[d] */
INT d ;
PT3 *a ;       /* a[d] */

{
    INT i ;

    for ( i=0 ; i<d ; i++ ) {
        if ( IS_SMALL(b[i][3]) )
            RETURN ( FALSE ) ;
        a[i][0] = b[i][0]/b[i][3] ;
        a[i][1] = b[i][1]/b[i][3] ;
        a[i][2] = b[i][2]/b[i][3] ;
    }
    RETURN ( TRUE ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE REAL c3a_hpoly_flat ( a, d ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                   All rights reserved                    !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
HPT3 *a ;
INT d ;
{
    INT i ;
    REAL norm_sq, dist, flatness, t ;
    PT3 c, b, vec ;

    flatness = 0.0 ;

    if ( HPT3_INF(a[0]) || HPT3_INF(a[d-1]) ) 
        RETURN ( -1.0 ) ;
    b[0] = a[0][0] / a[0][3] ;
    b[1] = a[0][1] / a[0][3] ;
    b[2] = a[0][2] / a[0][3] ;
    vec[0] = a[d-1][0] / a[d-1][3] - b[0] ;
    vec[1] = a[d-1][1] / a[d-1][3] - b[1] ;
    vec[2] = a[d-1][2] / a[d-1][3] - b[2] ;
    norm_sq = C3V_DOT ( vec, vec ) ;

    for ( i=1 ; i<d-1 ; i++ ) {

        if ( HPT3_INF(a[i]) ) 
            RETURN ( -1.0 ) ;
        c[0] = a[i][0] / a[i][3] - b[0] ;
        c[1] = a[i][1] / a[i][3] - b[1] ;
        c[2] = a[i][2] / a[i][3] - b[2] ;
        t = C3V_DOT ( c, vec ) / norm_sq ;

        if ( t < 0.0 )
            t = 0.0 ;
        else if ( t > 1.0 )
            t = 1.0 ;
        c[0] -= ( t * vec[0] ) ;
        c[1] -= ( t * vec[1] ) ;
        c[2] -= ( t * vec[2] ) ;

        dist = C3V_NORM ( c ) ;
        if ( dist > flatness ) 
            flatness = dist ;
    }
    RETURN ( flatness ) ;
}

/*-------------------------------------------------------------------------*/
BBS_PRIVATE REAL c3a_poly_flat ( a, d ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                   All rights reserved                    !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT3 *a ;
INT d ;
{
    INT i ;
    REAL norm_sq, dist, flatness, t ;
    PT3 c, vec ;

    flatness = 0.0 ;

    C3V_SUB ( a[d-1], a[0], vec ) ;
    norm_sq = C3V_DOT ( vec, vec ) ;

    for ( i=1 ; i<d-1 ; i++ ) {
        C3V_SUB ( a[i], a[0], c ) ;
        t = C3V_DOT ( c, vec ) / norm_sq ;
        if ( t < 0.0 )
            t = 0.0 ;
        else if ( t > 1.0 )
            t = 1.0 ;
        c[0] -= ( t * vec[0] ) ;
        c[1] -= ( t * vec[1] ) ;
        c[2] -= ( t * vec[2] ) ;

        dist = C3V_NORM ( c ) ;
        if ( dist > flatness ) 
            flatness = dist ;
    }
    RETURN ( flatness ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c3a_rot_cs_hpt ( a0, n, origin, axis, c, s, a1 ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
HPT3    *a0, *a1 ;
INT     n ;
PT3     origin, axis ;
REAL    c, s ;
{
    INT i ;

    for ( i=0 ; i<n ; i++ ) 
        c3h_rotate_cs ( a0[i], origin, axis, c, s, a1[i] ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c3a_rot_cs_pt ( a0, n, origin, axis, c, s, a1 ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT3    *a0, *a1 ;
INT     n ;
PT3     origin, axis ;
REAL    c, s ;
{
    INT i ;

    for ( i=0 ; i<n ; i++ ) 
        c3v_rotate_pt_cs ( a0[i], origin, axis, c, s, a1[i] ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c3a_conv_pt_3d2d ( a, n, c, u, v, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT3    *a ;
INT     n ;
PT3     c, u, v ;
PT2    *b ;
{
    INT i ;
    for ( i=0 ; i<n ; i++ ) 
        c3v_conv_pt_3d2d ( a[i], c, u, v, b[i] ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c3a_conv_hpt_3d2d ( a, n, c, u, v, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
HPT3    *a ;
INT     n ;
PT3     c, u, v ;
HPT2    *b ;
{
    INT i ;
    for ( i=0 ; i<n ; i++ ) 
        c3h_conv_3d2d ( a[i], c, u, v, b[i] ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c3a_conv_pt_2d3d ( b, n, c, u, v, a ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT2    *b ;
INT     n ;
PT3     c, u, v ;
PT3    *a ;
{
    INT i ;
    for ( i=0 ; i<n ; i++ ) 
        c3v_conv_pt_2d3d ( b[i], c, u, v, a[i] ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c3a_conv_hpt_2d3d ( b, n, c, u, v, a ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
HPT2    *b ;
INT     n ;
PT3     c, u, v ;
HPT3    *a ;
{
    INT i ;
    for ( i=0 ; i<n ; i++ ) 
        c3h_conv_2d3d ( b[i], c, u, v, a[i] ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE BOOLEAN c3a_project_hpt_oblique ( a, n, normal, 
            dist, direction, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
HPT3    *a ;
INT     n ;
PT3     normal, direction ;
REAL    dist ;
HPT3    *b ;
{
    INT i ;
    for ( i=0 ; i<n ; i++ ) 
        if ( !c3h_project_oblique ( a[i], normal, dist, direction, b[i] ) )
            RETURN ( FALSE ) ;
    RETURN ( TRUE ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void c3a_transform_hpt ( a, n, t, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
HPT3    *a ;
INT     n ;
C3_TRANSFORM t ;
HPT3    *b ;
{
    INT i ;
    for ( i=0 ; i<n ; i++ ) 
        c3t_eval_hpt ( a[i], t, b[i] ) ;
}
#endif   /*SPLINE*/

