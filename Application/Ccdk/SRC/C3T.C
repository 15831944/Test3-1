//================== SysCAD - Copyright Kenwalt (Pty) Ltd ===================
// $Nokeywords: $
//===========================================================================
/* -3 */
/********************************** C3T.C **********************************/
/***************************** 3d transforms *******************************/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
#include <aladefs.h>
#include <c3tdefs.h>
#include <c3tpriv.h>
#include <c3vdefs.h>
#include <c3vmcrs.h>

STATIC REAL*   c3t_mult0 __(( C3_TRANSFORM DUMMY0 , C3_TRANSFORM DUMMY1 ,
            C3_TRANSFORM DUMMY2 )) ;
STATIC REAL*   c3t_mult1 __(( C3_TRANSFORM DUMMY0 , C3_TRANSFORM DUMMY1 )) ;
STATIC REAL*   c3t_mult2 __(( C3_TRANSFORM DUMMY0 , C3_TRANSFORM DUMMY1 )) ;
/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL*   c3t_eval_2d ( a, t, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT2 a ;
C3_TRANSFORM t ;
PT3 b ;
{
    b[0] = a[0] * t[0][0] + a[1] * t[0][1] + t[0][3] ;
    b[1] = a[0] * t[1][0] + a[1] * t[1][1] + t[1][3] ;
    b[2] = a[0] * t[2][0] + a[1] * t[2][1] + t[2][3] ;
    RETURN ( (REAL*)b ) ;
}

/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL*   c3t_eval_pt ( a, t, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT3 a ;
C3_TRANSFORM t ;
PT3 b ;
{
    PT3 c ;
    c[0] = a[0] * t[0][0] + a[1] * t[0][1] + a[2] * t[0][2] + t[0][3] ;
    c[1] = a[0] * t[1][0] + a[1] * t[1][1] + a[2] * t[1][2] + t[1][3] ;
    c[2] = a[0] * t[2][0] + a[1] * t[2][1] + a[2] * t[2][2] + t[2][3] ;
    C3V_COPY ( c, b ) ;
    RETURN ( (REAL*)b ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c3t_copy ( t1, t2 ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C3_TRANSFORM t1, t2 ;
{
    ala_copy ( (REAL*)t1, 12, (REAL*)t2 ) ;
    RETURN ( (REAL*)t2 ) ;
}


#ifdef SPLINE
/*-------------------------------------------------------------------------*/
BBS_PRIVATE REAL*c3t_eval_hpt ( a, t, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
HPT3 a ;
C3_TRANSFORM t ;
HPT3 b ;
{
    PT3 c ;
    c[0] = a[0] * t[0][0] + a[1] * t[0][1] + a[2] * t[0][2] + a[3] * t[0][3] ;
    c[1] = a[0] * t[1][0] + a[1] * t[1][1] + a[2] * t[1][2] + a[3] * t[1][3] ;
    c[2] = a[0] * t[2][0] + a[1] * t[2][1] + a[2] * t[2][2] + a[3] * t[2][3] ;
    C3V_COPY ( c, b ) ;
    b[3] = a[3] ;
    RETURN ( (REAL*)b ) ;
}
#endif

/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL*c3t_eval_vec ( a, t, b ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT3 a ;
C3_TRANSFORM t ;
PT3 b ;
{
    PT3 c ;

    c[0] = a[0] * t[0][0] + a[1] * t[0][1] + a[2] * t[0][2] ;
    c[1] = a[0] * t[1][0] + a[1] * t[1][1] + a[2] * t[1][2] ;
    c[2] = a[0] * t[2][0] + a[1] * t[2][1] + a[2] * t[2][2] ;
    C3V_COPY ( c, b ) ;
    RETURN ( (REAL*)b ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC C3_TRANSFORM *c3t_create __(( void )) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
{
    REAL *t ;
    t = MALLOC ( 12, REAL ) ;
    t[0] = t[5] = t[10] = 1.0 ;
    t[1] = t[2] = t[3] = t[4] = t[6] = t[7] = t[8] = t[9] = t[11] = 0.0 ;
    RETURN ( (C3_TRANSFORM*)t ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c3t_lcs ( c, x, y, t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT3 c, x, y ;
C3_TRANSFORM t ;
{
    PT3 z ;

    C3V_CROSS ( x, y, z ) ;
    t[0][0] = x[0] ;
    t[0][1] = y[0] ;
    t[0][2] = z[0] ;
    t[0][3] = c[0] ;
    t[1][0] = x[1] ;
    t[1][1] = y[1] ;
    t[1][2] = z[1] ;
    t[1][3] = c[1] ;
    t[2][0] = x[2] ;
    t[2][1] = y[2] ;
    t[2][2] = z[2] ;
    t[2][3] = c[2] ;
    RETURN ( (REAL*)t ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC void c3t_free ( t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C3_TRANSFORM t ;
{
    FREE ( t ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c3t_mult ( t1, t2, t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C3_TRANSFORM t1, t2, t ;        /* t = t2 * t1 */
{
    if ( t == t1 ) 
        RETURN ( c3t_mult1 ( t1, t2 ) ) ;
    else if ( t == t2 ) 
        RETURN ( c3t_mult2 ( t1, t2 ) ) ;
    else 
        RETURN ( c3t_mult0 ( t1, t2, t ) ) ;
}


/*-------------------------------------------------------------------------*/
STATIC REAL* c3t_mult0 ( t1, t2, t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C3_TRANSFORM t1, t2, t ;        /* t = t2 * t1 */
{
    INT i, j ;
    for ( i=0 ; i<3 ; i++ ) {
        for ( j=0 ; j<3 ; j++ ) 
            t[i][j] = t2[i][0]*t1[0][j] + t2[i][1]*t1[1][j] + 
                t2[i][2]*t1[2][j] ;
        t[i][3] = t2[i][0]*t1[0][3] + t2[i][1]*t1[1][3] + 
            t2[i][2]*t1[2][3] + t2[i][3] ;
    }
    RETURN ( (REAL*)t ) ;
}


/*-------------------------------------------------------------------------*/
STATIC REAL* c3t_mult1 ( t1, t2 ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C3_TRANSFORM t1, t2 ;        /* t1 = t2 * t1 */
{
    C3_TRANSFORM t ;

    c3t_mult0 ( t1, t2, t ) ;
    c3t_copy ( t, t1 ) ;
    RETURN ( (REAL*)t1 ) ;
}


/*-------------------------------------------------------------------------*/
STATIC REAL* c3t_mult2 ( t1, t2 ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C3_TRANSFORM t1, t2 ;        /* t1 = t2 * t1 */
{
    C3_TRANSFORM t ;

    c3t_mult0 ( t1, t2, t ) ;
    c3t_copy ( t, t2 ) ;
    RETURN ( (REAL*)t1 ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC BOOLEAN c3t_orthogonal ( t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C3_TRANSFORM t ;
{
    REAL p0, p1, p2, tol ;

    p0 = t[0][0]*t[0][0] + t[1][0]*t[1][0] + t[2][0]*t[2][0] ;
    p1 = t[0][1]*t[0][1] + t[1][1]*t[1][1] + t[2][1]*t[2][1] ;
    p2 = t[0][2]*t[0][2] + t[1][2]*t[1][2] + t[2][2]*t[2][2] ;
    tol = BBS_ZERO * ( p0 + p1 + p2 ) ;

    RETURN ( ( fabs ( p0 - p1 ) <= tol ) && ( fabs ( p0 - p2 ) <= tol ) && 
    fabs ( t[0][0]*t[0][1] + t[1][0]*t[1][1] + t[2][0]*t[2][1] ) <= tol &&
    fabs ( t[0][0]*t[0][2] + t[1][0]*t[1][2] + t[2][0]*t[2][2] ) <= tol &&
    fabs ( t[0][1]*t[0][2] + t[1][1]*t[1][2] + t[2][1]*t[2][2] ) <= tol ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC BOOLEAN c3t_positive ( t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C3_TRANSFORM t ;
{
    RETURN ( c3t_det ( t ) > 0.0 ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c3t_translate ( shift, t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT3 shift ;
C3_TRANSFORM t ; 
{
    t[0][0] = t[1][1] = t[2][2] = 1.0 ;
    t[0][1] = t[0][2] = t[1][0] = t[1][2] = t[2][0] = t[2][1] = 0.0 ;
    t[0][3] = shift[0] ;
    t[1][3] = shift[1] ;
    t[2][3] = shift[2] ;
    RETURN ( (REAL*)t ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c3t_rotate ( origin, axis, angle, t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT3 origin, axis ;
REAL angle ;
C3_TRANSFORM t ; 
{
    REAL c, s ;
    c = cos ( angle ) ;
    s = sin ( angle ) ;
    RETURN ( c3t_rotate_cs ( origin, axis, c, s, t ) ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c3t_rotate_cs ( origin, axis, c, s, t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT3 origin, axis ;
REAL c, s ;
C3_TRANSFORM t ; 
{
    REAL dot, u ;
    PT3 n, cross ;

    if ( !c3v_normalize ( axis, n ) ) 
        RETURN ( NULL ) ;
    u = 1.0 - c ;
    dot = C3V_DOT ( origin, n ) ;
    C3V_CROSS ( n, origin, cross ) ;
    t[0][0] = n[0] * n[0] * u + c ;
    t[0][1] = n[1] * n[0] * u - s * n[2] ;
    t[0][2] = n[2] * n[0] * u + s * n[1] ;
    t[0][3] = u * ( origin[0] - dot * n[0] ) - s * cross[0] ;
    t[1][0] = n[0] * n[1] * u + s * n[2] ;
    t[1][1] = n[1] * n[1] * u + c ;
    t[1][2] = n[2] * n[1] * u - s * n[0] ;
    t[1][3] = u * ( origin[1] - dot * n[1] ) - s * cross[1] ;
    t[2][0] = n[0] * n[2] * u - s * n[1] ;
    t[2][1] = n[1] * n[2] * u + s * n[0] ;
    t[2][2] = n[2] * n[2] * u + c ;
    t[2][3] = u * ( origin[2] - dot * n[2] ) - s * cross[2] ;
    RETURN ( (REAL*)t ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c3t_scale ( origin, f0, f1, f2, t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT3 origin ;
REAL f0, f1, f2 ;
C3_TRANSFORM t ; 
{
    t[0][0] = f0 ;
    t[1][1] = f1 ;
    t[2][2] = f2 ;
    t[0][1] = t[0][2] = t[1][0] = t[1][2] = t[2][0] = t[2][1] = 0.0 ;
    t[0][3] = origin[0] * ( 1.0 - f0 ) ;
    t[1][3] = origin[1] * ( 1.0 - f1 ) ;
    t[2][3] = origin[2] * ( 1.0 - f2 ) ;
    RETURN ( (REAL*)t ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL* c3t_mirror ( normal, dist, t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT3 normal ;
REAL dist ;
C3_TRANSFORM t ; 
{
    t[0][0] = 1.0 - 2.0 * normal[0] * normal[0] ;
    t[1][1] = 1.0 - 2.0 * normal[1] * normal[1] ;
    t[2][2] = 1.0 - 2.0 * normal[2] * normal[2] ;
    t[0][1] = t[1][0] = - 2.0 * normal[0] * normal[1] ;
    t[0][2] = t[2][0] = - 2.0 * normal[0] * normal[2] ;
    t[1][2] = t[2][1] = - 2.0 * normal[1] * normal[2] ;
    t[0][3] = 2.0 * dist * normal[0] ;
    t[1][3] = 2.0 * dist * normal[1] ;
    t[2][3] = 2.0 * dist * normal[2] ;
    RETURN ( (REAL*)t ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL*   c3t_inverse ( t0, t1 ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C3_TRANSFORM t0, t1 ; 
{
    REAL det ;

    det = c3t_det ( t0 ) ;

    if ( IS_ZERO ( det ) ) 
        RETURN ( NULL ) ;
    t1[0][0] = ( t0[1][1] * t0[2][2] - t0[1][2] * t0[2][1] ) / det ;
    t1[0][1] = ( t0[0][2] * t0[2][1] - t0[0][1] * t0[2][2] ) / det ;
    t1[0][2] = ( t0[0][1] * t0[1][2] - t0[1][1] * t0[0][2] ) / det ;
    t1[1][0] = ( t0[1][2] * t0[2][0] - t0[1][0] * t0[2][2] ) / det ;
    t1[1][1] = ( t0[0][0] * t0[2][2] - t0[2][0] * t0[0][2] ) / det ;
    t1[1][2] = ( t0[0][2] * t0[1][0] - t0[0][0] * t0[1][2] ) / det ;
    t1[2][0] = ( t0[1][0] * t0[2][1] - t0[2][0] * t0[1][1] ) / det ;
    t1[2][1] = ( t0[0][1] * t0[2][0] - t0[0][0] * t0[2][1] ) / det ;
    t1[2][2] = ( t0[0][0] * t0[1][1] - t0[0][1] * t0[1][0] ) / det ;
    t1[0][3] = 
        - t1[0][0] * t0[0][3] - t1[0][1] * t0[1][3] - t1[0][2] * t0[2][3] ;
    t1[1][3] = 
        - t1[1][0] * t0[0][3] - t1[1][1] * t0[1][3] - t1[1][2] * t0[2][3] ;
    t1[2][3] = 
        - t1[2][0] * t0[0][3] - t1[2][1] * t0[1][3] - t1[2][2] * t0[2][3] ;
    RETURN ( (REAL*)t1 ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC REAL   c3t_det ( t ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C3_TRANSFORM t ; 
{
    RETURN ( t[0][0] * ( t[1][1] * t[2][2] - t[2][1] * t[1][2] ) + 
          t[0][1] * ( t[1][2] * t[2][0] - t[2][2] * t[1][0] ) + 
          t[0][2] * ( t[1][0] * t[2][1] - t[1][1] * t[2][0] ) ) ;
}

