//================== SysCAD - Copyright Kenwalt (Pty) Ltd ===================
// $Nokeywords: $
//===========================================================================
/* -3 */
/********************************* V3D.C ***********************************/
/***************** Display of 3-dim geometry in a viewport *****************/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
#include <c3cdefs.h>
#include <c3cpriv.h>
#include <c3ndefs.h>
#include <c3vdefs.h>
#include <grrdefs.h>
#include <v3ddefs.h>
#include <v3dpriv.h>
#include <vpidefs.h>
#include <c2vmcrs.h>
#include <c3vmcrs.h>
#include <vpmcrs.h>

STATIC void v3d_box1 __(( C3_BOX, REAL, VP_VIEWPORT )) ;
STATIC void v3d_box2 __(( C3_BOX, REAL, REAL, VP_VIEWPORT )) ;

/*-------------------------------------------------------------------------*/
BBS_PUBLIC void v3d_set_textposition ( pt, vp ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT3 pt ;
VP_VIEWPORT vp ;
{
    PT2 p ;
    V3D_PT_TRANSFORM ( pt, vp, p ) ;
    grr_set_textposition ( p ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC void v3d_moveto ( pt, vp ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT3 pt ;
VP_VIEWPORT vp ;
{
    PT2 p ;

    V3D_PT_TRANSFORM ( pt, vp, p ) ;
/*
    C2V_COPY ( p, VP_VIEWPORT_PREV_PT(vp) ) ;
*/
    grr_moveto ( p ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC void v3d_lineto ( pt, vp ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT3 pt ;
VP_VIEWPORT vp ;
{
    PT2 p ;
    v3d_moveto ( VP_VIEWPORT_PREV_PT(vp), vp ) ;
    V3D_PT_TRANSFORM ( pt, vp, p ) ;
    grr_lineto ( p ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC void v3d_curve ( curve, parm0, parm1, vp ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C3_CURVE curve ;
PARM parm0, parm1 ;
VP_VIEWPORT vp ;
{
    c3c_display ( curve, parm0, parm1, 
        VP_VIEWPORT_GRAN(vp), VP_VIEWPORT_VIEW_CTR_PT(vp), 
        2.0 * ( C3V_NORML1 ( VP_VIEWPORT_VIEW_X_VEC(vp) ) +  
        C3V_NORML1 ( VP_VIEWPORT_VIEW_Y_VEC(vp) ) ), 
        (PF_DISPLAY)v3d_buffer, vp ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC void v3d_point ( pt, size, vp ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT3 pt ;
REAL size ;
VP_VIEWPORT vp ;
{
    PT2 p ;

    V3D_PT_TRANSFORM ( pt, vp, p ) ;
    grr_point ( p, size ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PRIVATE void v3d_buffer ( a, n, vp ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT3 *a  ;
INT n ;
VP_VIEWPORT vp ;
{
    PT2 p ;
    INT i ;

    if ( n > 1 ) {
        V3D_PT_TRANSFORM ( a[0], vp, p ) ;
        grr_moveto ( p ) ;
        for ( i=1 ; i<n ; i++ ) {
            V3D_PT_TRANSFORM ( a[i], vp, p ) ;
            grr_lineto ( p ) ;
        }
    }
}

/*-------------------------------------------------------------------------*/
BBS_PUBLIC BOOLEAN v3d_select ( curve, pt, vp, sel_parm, dist_ptr ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                   All rights reserved                    !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C3_CURVE curve ;
PT3 pt ;
VP_VIEWPORT vp ;
PARM sel_parm ;
REAL *dist_ptr ;
{
    PT3 view_plane_normal ; 
    C3V_CROSS ( VP_VIEWPORT_VIEW_X_VEC(vp), 
        VP_VIEWPORT_VIEW_Y_VEC(vp), view_plane_normal ) ;
    RETURN ( c3c_select ( curve, pt, view_plane_normal, 
        vpi_get_select_width ( vp ), sel_parm, dist_ptr ) ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC void v3d_poly ( a, n, vp ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT3 *a  ;
INT n ;
VP_VIEWPORT vp ;
{
    PT3 p ;
    INT i ;

    if ( n > 1 ) {
        V3D_PT_TRANSFORM ( a[0], vp, p ) ;
        grr_moveto ( p ) ;
        for ( i=1 ; i<n ; i++ ) {
            V3D_PT_TRANSFORM ( a[i], vp, p ) ;
            grr_lineto ( p ) ;
        }
    }
}            

#ifdef SPLINE
/*-------------------------------------------------------------------------*/
BBS_PRIVATE void v3d_hpoly ( a, n, vp ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
HPT3 *a  ;
INT n ;
VP_VIEWPORT vp ;
{
    PT3 p0, p ;
    INT i, i0=0 ;

    for ( i=0 ; i<n && a[i][0] <= BBS_ZERO ; i++ ) 
        i0 = i+1 ;
    if ( i0 >= n ) 
        RETURN ;

    p0[0] = a[i0][0] / a[i0][3] ;
    p0[1] = a[i0][1] / a[i0][3] ;
    p0[2] = a[i0][2] / a[i0][3] ;
    V3D_PT_TRANSFORM ( p0, vp, p ) ;
    grr_moveto ( p ) ;

    for ( i=i0+1 ; i<n ; i++ ) {
        if ( a[i][3] > BBS_ZERO ) {
            p0[0] = a[i][0] / a[i][3] ;
            p0[1] = a[i][1] / a[i][3] ;
            p0[2] = a[i][2] / a[i][3] ;
            V3D_PT_TRANSFORM ( p0, vp, p ) ;
            grr_lineto ( p ) ;
        }
    }
}            
#endif

/*-------------------------------------------------------------------------*/
BBS_PUBLIC void v3d_curve_dir ( curve, dir, vp ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C3_CURVE curve ;
INT dir ;
VP_VIEWPORT vp ;
{
    PT3 pt, tan_vec ;

    if ( c3c_midpt_dir ( curve, dir, pt, tan_vec ) )
        v3d_arrow ( pt, tan_vec, 0.0125, 0.005, 0.008, vp ) ;
}


#ifdef SPLINE
/*-------------------------------------------------------------------------*/
BBS_PRIVATE void v3d_ctl_poly ( curve, vp ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C3_CURVE curve ;
VP_VIEWPORT vp ;
{
    HPT3 *c ;
    INT n ;

    if ( C3_CURVE_IS_SPLINE(curve) ) {
        c = c3n_get_ctpt ( C3_CURVE_NURB(curve) ) ;
        n = c3n_get_n ( C3_CURVE_NURB(curve) ) ;
        v3d_hpoly ( c, n, vp ) ;
    }
}
#endif /*SPLINE*/

/*-------------------------------------------------------------------------*/
BBS_PUBLIC void v3d_curve_box ( curve, vp ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C3_CURVE curve ;
VP_VIEWPORT vp ;
{
    v3d_box ( C3_CURVE_BOX(curve), vp ) ; 
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC void v3d_box ( box, vp ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C3_BOX box ;
VP_VIEWPORT vp ;
{
    v3d_box1 ( box, C3_MIN_Z(box), vp ) ;
    v3d_box1 ( box, C3_MAX_Z(box), vp ) ;
    v3d_box2 ( box, C3_MIN_X(box), C3_MIN_Y(box), vp ) ;
    v3d_box2 ( box, C3_MIN_X(box), C3_MAX_Y(box), vp ) ;
    v3d_box2 ( box, C3_MAX_X(box), C3_MIN_Y(box), vp ) ;
    v3d_box2 ( box, C3_MAX_X(box), C3_MAX_Y(box), vp ) ;
}


/*-------------------------------------------------------------------------*/
STATIC void v3d_box1 ( box, z, vp ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C3_BOX box ;
REAL z ;
VP_VIEWPORT vp ;
{
    PT3 p ;
    v3d_moveto ( c3v_set ( C3_MIN_X(box), C3_MIN_Y(box), z, p ), vp ) ;
    v3d_lineto ( c3v_set ( C3_MAX_X(box), C3_MIN_Y(box), z, p ), vp ) ;
    v3d_lineto ( c3v_set ( C3_MAX_X(box), C3_MAX_Y(box), z, p ), vp ) ;
    v3d_lineto ( c3v_set ( C3_MIN_X(box), C3_MAX_Y(box), z, p ), vp ) ;
    v3d_lineto ( c3v_set ( C3_MIN_X(box), C3_MIN_Y(box), z, p ), vp ) ;
}


/*-------------------------------------------------------------------------*/
STATIC void v3d_box2 ( box, x, y, vp ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
C3_BOX box ;
REAL x, y ;
VP_VIEWPORT vp ;
{
    PT3 p ;
    v3d_moveto ( c3v_set ( x, y, C3_MIN_Z(box), p ), vp ) ;
    v3d_lineto ( c3v_set ( x, y, C3_MAX_Z(box), p ), vp ) ;
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC void v3d_arrow ( pt, vec, a, b, h, vp ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
PT3 pt, vec ;
VP_VIEWPORT vp ;
REAL a, b, h ;
{
PT3 p, v={0,0,0} ;
    C3V_ADD ( pt, vec, p ) ;
    V3D_PT_TRANSFORM ( p, vp, v ) ;
    V3D_PT_TRANSFORM ( pt, vp, p ) ;
    C3V_SUB ( v, p, v ) ;
    c3v_normalize ( v, v ) ;
    grr_arrow ( p, v, a, b, h ) ;    
}


/*-------------------------------------------------------------------------*/
BBS_PUBLIC BOOLEAN v3d_pt_inside ( vp, a ) 
/*-------------------------------------------------------------------------*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/*!!!!!!!! (C) Copyright 1989, 1990, 1991 Building Block Software   !!!!!!!*/
/*!!!!!!!!                                                          !!!!!!!*/
/*!!!!!!!!                    All rights reserved                   !!!!!!!*/
/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
VP_VIEWPORT vp ;
PT3 a ;
{
    PT2 b ;

    V3D_PT_TRANSFORM ( a, vp, b ) ;
    RETURN ( vpi_pt_inside ( vp, b ) ) ;
}

